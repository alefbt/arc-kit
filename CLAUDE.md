# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

ArcKit is an **Enterprise Architecture Governance & Vendor Procurement Toolkit** - a Python CLI that provides 40 slash commands for AI coding assistants (Claude Code, Codex CLI, Gemini CLI) to generate architecture artifacts. It transforms architecture governance from scattered documents into a systematic, template-driven process.

## Build & Development Commands

```bash
# Install in development mode
pip install -e .
# Or using uv (recommended)
uv pip install -e .

# Test CLI
arckit --help
arckit check

# Test project initialization
arckit init test-project --ai claude --no-git
arckit init test-project --all-ai --no-git    # Install all AI formats
arckit init test-project --ai claude --minimal # Skip docs/guides
cd test-project && ls -la .claude/commands/

# Build distribution
python -m build

# Convert Claude commands to Gemini format
python scripts/converter.py

# Debug data path resolution
python -c "from arckit_cli import get_data_paths; print(get_data_paths())"
```

## Architecture

### Core Components

**CLI Entry Point** (`src/arckit_cli/__init__.py`):
- Single-file CLI using `typer` for command parsing
- `arckit init` creates project structure and copies templates/commands from package data
- `arckit check` validates tool installation
- `get_data_paths()` handles data resolution across install methods (uv tools, pip, source)

**Package Data** (distributed via `pyproject.toml` shared-data):
- `.claude/commands/arckit.*.md` - Slash commands (YAML frontmatter + prompt)
- `.claude/agents/arckit-*.md` - Autonomous agents (research, datascout, aws-research, azure-research)
- `.gemini/commands/arckit/*.toml` - Gemini equivalents (generated by `scripts/converter.py`)
- `.codex/prompts/arckit/*.md` - Codex prompts (same as Claude)
- `.arckit/templates/*.md` - Document templates
- `scripts/bash/*.sh` - Helper scripts
- `docs/guides/*.md` - Command usage guides
- `docs/README.md` - Documentation index
- `DEPENDENCY-MATRIX.md` - Command dependencies
- `WORKFLOW-DIAGRAMS.md` - Visual workflows

**Data Path Resolution Order** (in `get_data_paths()`):
1. uv tool install: `~/.local/share/uv/tools/arckit-cli/share/arckit/`
2. pip install: `{site-packages}/share/arckit/`
3. platformdirs: `{user_data_dir}/arckit/`
4. Source/dev mode: `{repo_root}/`

### Slash Command System

Commands live in `.claude/commands/arckit.{name}.md` with this structure:

```yaml
---
description: Brief description (shown in /help)
---

## User Input
$ARGUMENTS

## Instructions
1. Check prerequisites (principles exist, etc.)
2. Create/find project via create-project.sh --name "X" --json
3. Read template from .arckit/templates/{type}-template.md
4. Generate artifact using template structure
5. **Use Write tool** to create file (critical - avoids 32K token limit)
6. Show summary only (not full document)
```

**Multi-AI Command Formats**:
| AI | Format | Location |
|----|--------|----------|
| Claude Code | `/arckit.requirements` | `.claude/commands/arckit.requirements.md` |
| Codex CLI | `/prompts:arckit.requirements` | `.codex/prompts/arckit/requirements.md` |
| Gemini CLI | `/arckit:requirements` | `.gemini/commands/arckit/requirements.toml` |

### Agent System

Some commands delegate to **autonomous agents** (`.claude/agents/arckit-{name}.md`) that run as subprocesses via the Task tool. Agents are used for commands that perform extensive web research (dozens of WebSearch/WebFetch calls) to keep that context isolated from the main conversation.

**Current Agents**:
| Agent | Command | Purpose |
|-------|---------|---------|
| `arckit-research` | `/arckit.research` | Market research, vendor evaluation, build vs buy, TCO |
| `arckit-datascout` | `/arckit.datascout` | Data source discovery, API catalogue search, scoring |
| `arckit-aws-research` | `/arckit.aws-research` | AWS service research via AWS Knowledge MCP |
| `arckit-azure-research` | `/arckit.azure-research` | Azure service research via Microsoft Learn MCP |

**Agent file structure** (`.claude/agents/arckit-{name}.md`):
```yaml
---
name: arckit-{name}
description: |
  Use this agent when [triggering conditions]. Examples:
  <example>...</example>
model: inherit
color: cyan
---

You are [role description]...

## Process
1. Read prerequisites
2. Conduct web research
3. Write document to file
4. Return summary only
```

**When to make a command an agent**: If the command performs heavy WebSearch/WebFetch/MCP calls (>10 calls), reads many artifacts, or produces large intermediate context. The slash command becomes a thin wrapper that launches the agent via Task tool, with a fallback to direct execution.

**Multi-AI note**: Agents are Claude Code only. Codex and Gemini equivalents keep the full inline prompts since they don't support the Task/agent architecture. Do NOT re-run `scripts/converter.py` for agent-delegating commands — the existing Gemini TOMLs and Codex prompts should retain their full instructions.

### Project Structure Created by `arckit init`

```
project/
├── .arckit/
│   ├── templates/        # Document templates
│   └── scripts/bash/     # create-project.sh, generate-document-id.sh, etc.
├── .claude/
│   ├── commands/         # Slash commands (or .codex/ or .gemini/, or all with --all-ai)
│   └── agents/           # Autonomous agents (research, datascout)
├── docs/                 # Documentation (unless --minimal)
│   ├── README.md         # Documentation index
│   └── guides/           # Command usage guides
├── DEPENDENCY-MATRIX.md  # Command dependencies (unless --minimal)
├── WORKFLOW-DIAGRAMS.md  # Visual workflows (unless --minimal)
└── projects/
    ├── 000-global/       # Cross-project artifacts
    │   └── ARC-000-PRIN-v1.0.md  # Global architecture principles
    └── 001-project-name/ # Numbered project directories
        ├── ARC-001-REQ-v1.0.md      # Requirements
        ├── ARC-001-STKE-v1.0.md     # Stakeholder analysis
        ├── ARC-001-RISK-v1.0.md     # Risk register
        ├── ARC-001-SOBC-v1.0.md     # Business case
        ├── ARC-001-ADR-001-v1.0.md  # ADRs (multi-instance)
        ├── ARC-001-DIAG-001-v1.0.md # Diagrams (multi-instance)
        └── vendors/
```

**Init flags:**
- `--ai claude|gemini|codex` - Select AI assistant (default: prompt)
- `--all-ai` - Install commands for all AI assistants
- `--minimal` - Skip docs, guides, and reference files
- `--no-git` - Skip git repository initialization
- `--here` - Initialize in current directory

### Helper Scripts

**`scripts/bash/create-project.sh`**: Creates numbered project directories (001-*, 002-*), returns JSON with path
**`scripts/bash/generate-document-id.sh`**: Generates doc IDs (e.g., ARC-001-REQ-v1.0) and filenames
  - `--filename` flag returns the filename with `.md` extension
  - `--next-num` flag returns the next sequential number for multi-instance types (ADR, DIAG, WARD, DMC)
**`scripts/bash/migrate-filenames.sh`**: Migrates existing project files to new naming convention
**`scripts/converter.py`**: Converts Claude commands (.md) to Gemini format (.toml)

## Adding a New Slash Command

1. Create `.claude/commands/arckit.{name}.md` with YAML frontmatter
2. Create `.arckit/templates/{name}-template.md` with document control section
3. Create `docs/guides/{name}.md` with usage guide
4. If command needs heavy web research (>10 WebSearch/WebFetch calls), also create `.claude/agents/arckit-{name}.md` and make the slash command a thin wrapper that delegates to the agent
5. Run `python scripts/converter.py` to generate Gemini TOML
6. Test: `arckit init test --ai claude --no-git && cd test && claude`
7. Update documentation: README.md, docs/index.html, DEPENDENCY-MATRIX.md, CHANGELOG.md

**Command must**:
- Check prerequisites before generating
- Use `create-project.sh --json` to get/create project path
- Read the corresponding template file
- **Use Write tool** to save output (avoids token limit issues)
- Show only a summary to user
- Delegate to agent if research-heavy (see Agent System above)

### Document Control Standard

Every template must start with a **Document Control** table followed by **Revision History**:

**Document Control fields** (in order):
| Field | Example |
|-------|---------|
| Document ID | `ARC-001-REQ-v1.0` (use `generate-document-id.sh`) |
| Document Type | Requirements Specification |
| Project | PROJECT_NAME (Project PROJECT_ID) |
| Classification | PUBLIC / OFFICIAL / OFFICIAL-SENSITIVE / SECRET |
| Status | DRAFT / IN_REVIEW / APPROVED / PUBLISHED / SUPERSEDED / ARCHIVED |
| Version | 1.0 |
| Created Date | YYYY-MM-DD |
| Last Modified | YYYY-MM-DD |
| Review Cycle | Monthly / Quarterly / Annual / On-Demand |
| Next Review Date | YYYY-MM-DD |
| Owner | Role or individual |
| Reviewed By | Name (date) or PENDING |
| Approved By | Name (date) or PENDING |
| Distribution | Distribution list |

> Domain-specific fields (e.g., "ADR Number", "Assessment Phase") go **after** standard fields.

**Revision History columns**: Version | Date | Author | Changes | Approved By | Approval Date

**Standard Footer** (at end of every template):
```markdown
---

**Generated by**: ArcKit `/arckit.{command}` command
**Generated on**: [DATE]
**ArcKit Version**: [VERSION]
**Project**: [PROJECT_NAME]
**Model**: [AI_MODEL]
```

## Version Management

**Version defined in 2 places** (keep synchronized):
1. `VERSION` file (source of truth)
2. `pyproject.toml` `version` field

**Adding new package data files**: Update `pyproject.toml` `[tool.hatch.build.targets.wheel.shared-data]`

## Test Repositories

ArcKit maintains 20 test repos on GitHub (pattern: `arckit-test-project-v*`):

| Version | Name | Type | Description |
|---------|------|------|-------------|
| v0 | mod-chatbot | Private | MOD chatbot project |
| v1 | m365 | Public | Microsoft 365 migration |
| v2 | hmrc-chatbot | Public | HMRC chatbot |
| v3 | windows11 | Public | Windows 11 deployment |
| v4 | ipa | Private | Infrastructure Projects Authority |
| v5 | dstl | Private | Defence Science & Technology Lab |
| v6 | patent-system | Public | Patent system modernization |
| v7 | nhs-appointment | Public | NHS appointment booking |
| v8 | ons-data-platform | Public | ONS data platform |
| v9 | cabinet-office-genai | Public | Cabinet Office GenAI |
| v10 | training-marketplace | Public | UK Government Training Marketplace |
| v11 | national-highways-data | Public | National Highways data architecture |
| v12 | honky-tonks | Private | Restaurant data analytics |
| v13 | plymouth-research | Private | Plymouth restaurant web scraping |
| v14 | scottish-courts | Public | Scottish Courts and Tribunals Service GenAI strategy |
| v15 | ipad-framework | Private | Investment Promotion Agency Data Framework |
| v16 | doctors-appointment | Public | Doctors Online Appointment System |
| v17 | fuel-prices | Public | UK Government Fuel Price Transparency Service |
| v18 | smart-meter | Public | UK Smart Meter Data Consumer Mobile App |
| v19 | gov-api-aggregator | Public | UK Government API Aggregator |
| v20 | uae-moi-ipad | Private | UAE MOI IPAD Framework |

**Sync test repos after changes**:
```bash
# Clone and update all test repos
TOKEN="<github-token>"
for repo in v0-mod-chatbot v1-m365 v2-hmrc-chatbot v3-windows11 v4-ipa v5-dstl \
            v6-patent-system v7-nhs-appointment v8-ons-data-platform v9-cabinet-office-genai \
            v10-training-marketplace v11-national-highways-data v12-honky-tonks v13-plymouth-research \
            v14-scottish-courts v15-ipad-framework v16-doctors-appointment v17-fuel-prices \
            v18-smart-meter v19-gov-api-aggregator v20-uae-moi-ipad; do
    git clone "https://x-access-token:${TOKEN}@github.com/tractorjuice/arckit-test-project-$repo.git" /tmp/$repo
    # Sync commands, agents, and templates
    rsync -av --delete .claude/commands/ /tmp/$repo/.claude/commands/
    mkdir -p /tmp/$repo/.claude/agents
    rsync -av --delete .claude/agents/ /tmp/$repo/.claude/agents/
    rsync -av --delete .codex/prompts/ /tmp/$repo/.codex/prompts/
    rsync -av --delete .gemini/commands/ /tmp/$repo/.gemini/commands/
    rsync -av --delete .arckit/templates/ /tmp/$repo/.arckit/templates/
    rsync -av scripts/bash/ /tmp/$repo/.arckit/scripts/bash/
    # Sync guides and docs README
    mkdir -p /tmp/$repo/docs/guides
    rsync -av --delete docs/guides/ /tmp/$repo/docs/guides/
    cp docs/README.md /tmp/$repo/docs/README.md
    # Sync root docs (NOT README.md, docs/index.html, or CLAUDE.md - those are repo-specific)
    cp DEPENDENCY-MATRIX.md CHANGELOG.md WORKFLOW-DIAGRAMS.md VERSION /tmp/$repo/
    # Sync MCP configuration
    cp .mcp.json /tmp/$repo/.mcp.json
    # Sync devcontainer
    mkdir -p /tmp/$repo/.devcontainer
    cp -r .devcontainer/ /tmp/$repo/.devcontainer/
    # Ensure standard directories exist (external docs support)
    mkdir -p /tmp/$repo/projects/000-global/policies
    for proj_dir in /tmp/$repo/projects/[0-9][0-9][0-9]-*/; do
        [ -d "$proj_dir" ] && mkdir -p "$proj_dir/external"
    done
    cd /tmp/$repo && git add -A && git commit -m "chore: sync with arc-kit" && git push && cd -
done
```

**Note**: `README.md`, `docs/index.html`, and `CLAUDE.md` are NOT synced - these are repo-specific. `docs/README.md` and `.mcp.json` ARE synced. After syncing template changes to `pages-template.html`, re-run `/arckit.pages` in each repo that has a `docs/index.html` to regenerate it with the updated template.

## Key Patterns

**Agent Delegation**: Commands that perform heavy web research (research, datascout) delegate to agents in `.claude/agents/` via the Task tool. The slash command is a thin wrapper; the agent runs autonomously in its own context window.

**Token Limit Handling**: Commands MUST use Write tool for large documents (requirements, SOBC, research) to avoid 32K output token limit.

**Template-Driven Generation**: Never generate freeform documents - always use templates from `.arckit/templates/`.

**Traceability Chain**: Stakeholders → Goals → Requirements (BR/FR/NFR/INT/DR) → Data Model → Components → User Stories

**Requirement ID Prefixes**:
- BR-xxx: Business Requirements
- FR-xxx: Functional Requirements
- NFR-xxx: Non-Functional (NFR-P-xxx Performance, NFR-SEC-xxx Security, etc.)
- INT-xxx: Integration Requirements
- DR-xxx: Data Requirements

**UK Government Context**: Many commands target UK public sector (GDS Service Standard, TCoP, NCSC CAF, Orange/Green Book, G-Cloud/DOS procurement). See README.md for full compliance coverage.

**Wardley Map Format**: OnlineWardleyMaps syntax for visualization at https://create.wardleymaps.ai
